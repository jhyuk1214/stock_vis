import streamlit as st
import matplotlib.pyplot as plt
from stock_analyzer import StockAnalyzer
from chart_visualizer import ChartVisualizer
import pandas as pd

st.set_page_config(page_title="ì£¼ì‹ ì‹œê°í™” ì•±", page_icon="ğŸ“ˆ", layout="wide")

# CSSë¡œ í†µì¼ëœ í°íŠ¸ ì„¤ì • (í¬ë¡œìŠ¤ í”Œë«í¼)
st.markdown("""
<style>
    html, body, [class*="css"] {
        font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', 'Noto Sans CJK KR', sans-serif !important;
    }
    .stMetric-value {
        font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', 'Noto Sans CJK KR', sans-serif !important;
    }
    .stMarkdown {
        font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', 'Noto Sans CJK KR', sans-serif !important;
    }
</style>
""", unsafe_allow_html=True)

def main():
    st.title("ğŸ“ˆ Stock Value Analysis Visualization")
    st.markdown("Enter a stock ticker to see a value analysis chart based on the 200-week moving average.")
    
    # ì¸ê¸° í‹°ì»¤ ëª©ë¡
    popular_tickers = [
        "AAPL - Apple Inc.",
        "MSFT - Microsoft Corporation", 
        "GOOGL - Alphabet Inc.",
        "AMZN - Amazon.com Inc.",
        "TSLA - Tesla Inc.",
        "NVDA - NVIDIA Corporation",
        "META - Meta Platforms Inc.",
        "NFLX - Netflix Inc.",
        "BTC-USD - Bitcoin USD",
        "ETH-USD - Ethereum USD",
        "SPY - SPDR S&P 500 ETF",
        "QQQ - Invesco QQQ Trust"
    ]
    
    # ë“œë¡­ë‹¤ìš´ê³¼ í…ìŠ¤íŠ¸ ì…ë ¥ ì¡°í•©
    col1, col2 = st.columns([2, 1])
    
    with col1:
        ticker_input = st.text_input(
            "ì£¼ì‹ í‹°ì»¤ ì§ì ‘ ì…ë ¥", 
            value="", 
            placeholder="ì˜ˆ: AAPL, BTC-USD"
        )
    
    with col2:
        selected_ticker = st.selectbox(
            "ë˜ëŠ” ì¸ê¸° ì¢…ëª© ì„ íƒ",
            [""] + popular_tickers,
            index=0
        )
    
    # ì„ íƒëœ í‹°ì»¤ê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ìš°ì„  ì‚¬ìš©
    if selected_ticker:
        ticker_input = selected_ticker.split(" - ")[0]
    
    if ticker_input:
        try:
            with st.spinner(f'{ticker_input} ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...'):
                analyzer = StockAnalyzer(ticker_input)
                data = analyzer.get_weekly_data()
                ma_200w = analyzer.calculate_200w_ma(data)
                
                current_price = data['Close'].iloc[-1]
                zones, latest_ma = analyzer.calculate_price_zones(current_price, ma_200w)
                current_zone = analyzer.get_current_zone(current_price, zones)
                
                visualizer = ChartVisualizer()
                fig = visualizer.create_chart(data, ma_200w, zones, current_zone, ticker_input.upper())
                
                st.pyplot(fig)
                
                col1, col2, col3 = st.columns(3)
                
                with col1:
                    st.metric("í˜„ì¬ ì£¼ê°€", f"${current_price:.2f}")
                
                with col2:
                    st.metric("200ì£¼ ì´ë™í‰ê· ", f"${latest_ma:.2f}")
                
                with col3:
                    zone_korean = visualizer._get_zone_korean(current_zone)
                    st.metric("í˜„ì¬ ê°€ì¹˜ êµ¬ê°„", zone_korean)
                
                with st.expander("êµ¬ê°„ë³„ ê°€ê²© ë²”ìœ„"):
                    for zone_name, (lower, upper) in zones.items():
                        zone_kr = visualizer._get_zone_korean(zone_name)
                        if upper == float('inf'):
                            st.write(f"**{zone_kr}**: {lower:.2f} ì´ìƒ")
                        else:
                            st.write(f"**{zone_kr}**: {lower:.2f} - {upper:.2f}")
        
        except ValueError as e:
            st.error(f"ì˜¤ë¥˜: {e}")
        except Exception as e:
            st.error(f"ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")

if __name__ == "__main__":
    main()