import streamlit as st
import matplotlib.pyplot as plt
from stock_analyzer import StockAnalyzer
from chart_visualizer import ChartVisualizer
import pandas as pd

st.set_page_config(page_title="주식 시각화 앱", page_icon="📈", layout="wide")

# CSS로 통일된 폰트 설정 (크로스 플랫폼)
st.markdown("""
<style>
    html, body, [class*="css"] {
        font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', 'Noto Sans CJK KR', sans-serif !important;
    }
    .stMetric-value {
        font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', 'Noto Sans CJK KR', sans-serif !important;
    }
    .stMarkdown {
        font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', 'Noto Sans CJK KR', sans-serif !important;
    }
</style>
""", unsafe_allow_html=True)

def main():
    st.title("📈 Stock Value Analysis Visualization")
    st.markdown("Enter a stock ticker to see a value analysis chart based on the 200-week moving average.")
    
    # 인기 티커 목록
    popular_tickers = [
        "AAPL - Apple Inc.",
        "MSFT - Microsoft Corporation", 
        "GOOGL - Alphabet Inc.",
        "AMZN - Amazon.com Inc.",
        "TSLA - Tesla Inc.",
        "NVDA - NVIDIA Corporation",
        "META - Meta Platforms Inc.",
        "NFLX - Netflix Inc.",
        "BTC-USD - Bitcoin USD",
        "ETH-USD - Ethereum USD",
        "SPY - SPDR S&P 500 ETF",
        "QQQ - Invesco QQQ Trust"
    ]
    
    # 드롭다운과 텍스트 입력 조합
    col1, col2 = st.columns([2, 1])
    
    with col1:
        ticker_input = st.text_input(
            "주식 티커 직접 입력", 
            value="", 
            placeholder="예: AAPL, BTC-USD"
        )
    
    with col2:
        selected_ticker = st.selectbox(
            "또는 인기 종목 선택",
            [""] + popular_tickers,
            index=0
        )
    
    # 선택된 티커가 있으면 그것을 우선 사용
    if selected_ticker:
        ticker_input = selected_ticker.split(" - ")[0]
    
    if ticker_input:
        try:
            with st.spinner(f'{ticker_input} 데이터를 불러오는 중...'):
                analyzer = StockAnalyzer(ticker_input)
                data = analyzer.get_weekly_data()
                ma_200w = analyzer.calculate_200w_ma(data)
                
                current_price = data['Close'].iloc[-1]
                zones, latest_ma = analyzer.calculate_price_zones(current_price, ma_200w)
                current_zone = analyzer.get_current_zone(current_price, zones)
                
                visualizer = ChartVisualizer()
                fig = visualizer.create_chart(data, ma_200w, zones, current_zone, ticker_input.upper())
                
                st.pyplot(fig)
                
                col1, col2, col3 = st.columns(3)
                
                with col1:
                    st.metric("현재 주가", f"${current_price:.2f}")
                
                with col2:
                    st.metric("200주 이동평균", f"${latest_ma:.2f}")
                
                with col3:
                    zone_korean = visualizer._get_zone_korean(current_zone)
                    st.metric("현재 가치 구간", zone_korean)
                
                with st.expander("구간별 가격 범위"):
                    for zone_name, (lower, upper) in zones.items():
                        zone_kr = visualizer._get_zone_korean(zone_name)
                        if upper == float('inf'):
                            st.write(f"**{zone_kr}**: {lower:.2f} 이상")
                        else:
                            st.write(f"**{zone_kr}**: {lower:.2f} - {upper:.2f}")
        
        except ValueError as e:
            st.error(f"오류: {e}")
        except Exception as e:
            st.error(f"데이터를 불러오는 중 오류가 발생했습니다: {e}")

if __name__ == "__main__":
    main()